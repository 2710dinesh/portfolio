<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessible Login - Voice & Manual</title>
    <style>
        /* ==================== GLOBAL STYLES ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        /* ==================== MANUAL LOGIN FORM ==================== */
        .login-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="email"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ==================== VOICE LOGIN SECTION ==================== */
        .voice-section {
            text-align: center;
        }

        .voice-section h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
        }

        .btn-voice {
            width: 100%;
            padding: 16px;
            background: #00bcd4;
            color: white;
            border: 3px solid #00bcd4;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .btn-voice:hover:not(:disabled) {
            background: #00acc1;
            border-color: #00acc1;
            transform: scale(1.02);
        }

        .btn-voice:focus {
            outline: 3px solid #ff9800;
            outline-offset: 3px;
        }

        .btn-voice:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-voice.active {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(0, 188, 212, 0.7);
            }

            50% {
                box-shadow: 0 0 0 15px rgba(0, 188, 212, 0);
            }
        }

        /* ==================== STATUS & FEEDBACK ==================== */
        .status-container {
            margin-top: 20px;
            min-height: 60px;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: 500;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .alert-success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }

        .alert-error {
            background: #ffebee;
            color: #d32f2f;
            border-left: 4px solid #d32f2f;
        }

        .alert-warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #f57c00;
        }

        /* Live region for screen readers */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* ==================== ACCESSIBILITY ENHANCEMENTS ==================== */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #000;
            color: #fff;
            padding: 8px;
            text-decoration: none;
            z-index: 100;
        }

        .skip-link:focus {
            top: 0;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {

            .btn-primary,
            .btn-voice {
                border: 3px solid currentColor;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }

        /* ==================== MICROPHONE STATUS INDICATOR ==================== */
        .mic-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #4caf50;
            border-radius: 50%;
            margin-left: 10px;
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            50%,
            100% {
                opacity: 1;
            }

            25%,
            75% {
                opacity: 0.2;
            }
        }
    </style>
</head>

<body>
    <!-- Skip link for keyboard navigation -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Live region for screen reader announcements -->
    <div id="sr-announcements" class="sr-only" role="status" aria-live="polite" aria-atomic="true"></div>

    <main id="main-content" class="container" role="main">
        <h1>Login to Your Account</h1>
        <p class="subtitle">Choose your preferred login method</p>

        <!-- ==================== MANUAL LOGIN FORM ==================== -->
        <section class="login-section" aria-label="Manual Login Form">
            <form id="manualLoginForm" aria-label="Manual login form">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" required aria-required="true"
                        aria-describedby="email-hint" autocomplete="email" placeholder="Enter your email">
                    <span id="email-hint" class="sr-only">Enter your registered email address</span>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required aria-required="true"
                        aria-describedby="password-hint" autocomplete="current-password"
                        placeholder="Enter your password">
                    <span id="password-hint" class="sr-only">Enter your password</span>
                </div>

                <button type="submit" class="btn-primary" id="manualLoginBtn"
                    aria-label="Login with email and password">
                    Login
                </button>
            </form>
        </section>

        <!-- ==================== VOICE LOGIN SECTION ==================== -->
        <section class="voice-section" aria-label="Voice Login for Blind Users">
            <h2 id="voice-login-heading">Voice Login (For Blind Users)</h2>
            <p class="subtitle">Click the button and follow voice instructions</p>

            <button type="button" id="voiceLoginBtn" class="btn-voice"
                aria-label="Start voice login for blind users. Click and follow spoken instructions."
                aria-describedby="voice-login-heading" aria-live="polite">
                ðŸŽ¤ Start Voice Login
            </button>

            <!-- Status feedback area -->
            <div id="statusContainer" class="status-container" role="region" aria-label="Login status"
                aria-live="polite">
                <!-- Dynamic status messages will appear here -->
            </div>
        </section>
    </main>

    <!-- ==================== JAVASCRIPT: VOICE ASSISTANT LOGIC ==================== -->
    <script>
        'use strict';

        // ==================== CONFIGURATION ====================
        const CONFIG = {
            MAX_RETRIES: 3,
            SPEECH_LANG: 'en-US',
            SPEECH_RATE: 0.9,
            SPEECH_PITCH: 1.0,
            SPEECH_VOLUME: 1.0,
            // Demo mode - no backend required
            DEMO_MODE: true
        };

        // ==================== STATE MANAGEMENT ====================
        const state = {
            step: 0,
            email: '',
            password: '',
            isListening: false,
            retryCount: 0,
            recognitionActive: false
        };

        // ==================== DOM ELEMENTS ====================
        const elements = {
            voiceLoginBtn: document.getElementById('voiceLoginBtn'),
            manualLoginForm: document.getElementById('manualLoginForm'),
            manualLoginBtn: document.getElementById('manualLoginBtn'),
            statusContainer: document.getElementById('statusContainer'),
            srAnnouncements: document.getElementById('sr-announcements')
        };

        // ==================== SPEECH SYNTHESIS (TTS) ====================
        const synth = window.speechSynthesis;

        /**
         * Speaks text using Text-to-Speech with accessibility optimizations
         * @param {string} text - Text to speak
         * @param {Object} options - Speech options
         */
        function speak(text, options = {}) {
            return new Promise((resolve, reject) => {
                // Cancel any ongoing speech
                synth.cancel();

                // Create utterance
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = CONFIG.SPEECH_LANG;
                utterance.rate = options.rate || CONFIG.SPEECH_RATE;
                utterance.pitch = options.pitch || CONFIG.SPEECH_PITCH;
                utterance.volume = options.volume || CONFIG.SPEECH_VOLUME;

                // Event handlers
                utterance.onend = () => resolve();
                utterance.onerror = (err) => {
                    console.error('Speech synthesis error:', err);
                    reject(err);
                };

                // Also announce to screen readers
                announceToScreenReader(text);

                // Speak
                synth.speak(utterance);
            });
        }

        /**
         * Announces text to screen readers via live region
         * @param {string} text - Text to announce
         */
        function announceToScreenReader(text) {
            if (elements.srAnnouncements) {
                elements.srAnnouncements.textContent = text;
            }
        }

        // ==================== SPEECH RECOGNITION (STT) ====================
        let recognition = null;
        let speechAvailable = null; // null = not tested, true = working, false = failed

        /**
         * Tests if speech recognition is available and working
         */
        async function testSpeechRecognition() {
            return new Promise((resolve) => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {
                    console.log('Speech Recognition not supported');
                    resolve(false);
                    return;
                }

                try {
                    const testRecognition = new SpeechRecognition();
                    testRecognition.lang = CONFIG.SPEECH_LANG;
                    
                    const timeout = setTimeout(() => {
                        try {
                            testRecognition.stop();
                        } catch (e) {}
                        console.log('Speech Recognition test timeout - assuming it works');
                        resolve(true);
                    }, 2000);

                    testRecognition.onerror = (event) => {
                        clearTimeout(timeout);
                        console.log('Speech Recognition test error:', event.error);
                        resolve(false);
                    };

                    testRecognition.onstart = () => {
                        clearTimeout(timeout);
                        testRecognition.stop();
                        console.log('Speech Recognition test successful');
                        resolve(true);
                    };

                    testRecognition.start();
                } catch (error) {
                    console.log('Speech Recognition test failed:', error);
                    resolve(false);
                }
            });
        }

        /**
         * Initializes Speech Recognition
         */
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                showStatus('Speech recognition is not supported in this browser. Please use Chrome or Edge.', 'error');
                speak('Speech recognition is not supported in this browser. Please use Chrome or Edge.');
                return null;
            }

            recognition = new SpeechRecognition();
            recognition.lang = CONFIG.SPEECH_LANG;
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            // Event: Result received
            recognition.onresult = handleSpeechResult;

            // Event: Recognition ends
            recognition.onend = () => {
                state.recognitionActive = false;
                updateVoiceButtonState(false);
            };

            // Event: Recognition error
            recognition.onerror = handleSpeechError;

            // Event: No speech detected
            recognition.onnomatch = () => {
                speak('Sorry, I did not understand. Please try again.');
                if (state.step > 0) {
                    promptCurrentStep();
                }
            };

            return recognition;
        }

        /**
         * Starts listening for voice input
         */
        function startListening() {
            if (!recognition) {
                recognition = initSpeechRecognition();
            }

            if (recognition && !state.recognitionActive) {
                try {
                    recognition.start();
                    state.recognitionActive = true;
                    state.isListening = true;
                    updateVoiceButtonState(true);
                } catch (error) {
                    console.error('Recognition start error:', error);
                    showStatus('Failed to start voice recognition. Please try again.', 'error');
                }
            }
        }

        /**
         * Handles speech recognition result
         * @param {SpeechRecognitionEvent} event - Recognition event
         */
        function handleSpeechResult(event) {
            const transcript = event.results[0][0].transcript;
            const confidence = event.results[0][0].confidence;

            console.log(`Recognized: "${transcript}" (confidence: ${confidence})`);

            // Sanitize input to prevent XSS
            const sanitizedInput = sanitizeInput(transcript);

            // Process based on current step
            processVoiceInput(sanitizedInput);
        }

        /**
         * Handles speech recognition errors
         * @param {SpeechRecognitionError} event - Error event
         */
        function handleSpeechError(event) {
            console.error('Speech recognition error:', event.error);

            let errorMessage = '';
            switch (event.error) {
                case 'no-speech':
                    errorMessage = 'No speech was detected. Please try again.';
                    break;
                case 'audio-capture':
                    errorMessage = 'Microphone is not accessible. Please check your microphone permissions.';
                    break;
                case 'not-allowed':
                    errorMessage = 'Microphone permission denied. Please allow microphone access in your browser settings.';
                    break;
                case 'network':
                    errorMessage = 'Voice recognition network error. This feature requires internet for speech recognition. Please check your connection and try again.';
                    break;
                case 'service-not-allowed':
                    errorMessage = 'Speech recognition service is not available. Please try again later.';
                    break;
                default:
                    errorMessage = `Voice recognition error (${event.error}). Please try again or use manual login.`;
            }

            showStatus(errorMessage, 'error');
            speak(errorMessage).catch(() => {
                // If TTS also fails, just show visual feedback
                console.error('TTS failed during error announcement');
            });

            // Reset and allow retry
            state.recognitionActive = false;
            updateVoiceButtonState(false);

            // For network errors, suggest using manual login
            if (event.error === 'network' || event.error === 'service-not-allowed') {
                setTimeout(() => {
                    showStatus(errorMessage + ' You can use the manual login form above.', 'warning');
                }, 2000);
            }
        }

        // ==================== INPUT PROCESSING ====================
        /**
         * Sanitizes user input to prevent XSS and injection attacks
         * @param {string} input - Raw input string
         * @returns {string} - Sanitized input
         */
        function sanitizeInput(input) {
            if (!input) return '';

            // Remove HTML tags, scripts, and special characters that could be malicious
            return input
                .trim()
                .replace(/<[^>]*>/g, '') // Remove HTML tags
                .replace(/[<>\"\']/g, '') // Remove special characters
                .substring(0, 200); // Limit length
        }

        /**
         * Validates email format
         * @param {string} email - Email to validate
         * @returns {boolean} - Is valid email
         */
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        /**
         * Processes voice input based on current step
         * @param {string} input - Sanitized voice input
         */
        async function processVoiceInput(input) {
            if (state.step === 0) {
                console.error('Process called with step 0, resetting');
                await speak('Voice login was interrupted. Please click the button to start again.');
                resetVoiceLogin();
                return;
            }

            switch (state.step) {
                case 1: // Email input
                    await handleEmailInput(input);
                    break;
                case 2: // Password input
                    await handlePasswordInput(input);
                    break;
                case 3: // Confirmation
                    await handleConfirmation(input);
                    break;
                default:
                    console.error('Invalid step:', state.step);
                    await speak('An error occurred. Please click the voice login button to restart.');
                    resetVoiceLogin();
            }
        }

        /**
         * Handles email voice input
         * @param {string} input - Voice input for email
         */
        async function handleEmailInput(input) {
            // Convert spoken email to text format
            // e.g., "john dot doe at example dot com" -> "john.doe@example.com"
            let email = input
                .toLowerCase()
                .replace(/\s+at\s+/g, '@')
                .replace(/\s+dot\s+/g, '.')
                .replace(/\s+/g, '');

            state.email = email;

            showStatus(`Email captured: ${email}`, 'info');

            if (isValidEmail(email)) {
                await speak(`Email received: ${email}. Please say your password.`);
                state.step = 2;
                if (speechAvailable) {
                    startListening();
                } else {
                    showTextFallback('Please type your password:');
                }
            } else {
                await speak('The email format seems incorrect. Please say your email again. For example, say john dot doe at example dot com.');
                state.step = 1;
                if (speechAvailable) {
                    startListening();
                } else {
                    showTextFallback('Please type your email address (e.g., john@example.com):');
                }
            }
        }

        /**
         * Handles password voice input
         * @param {string} input - Voice input for password
         */
        async function handlePasswordInput(input) {
            // Remove spaces from password
            const password = input.replace(/\s+/g, '');
            state.password = password;

            showStatus('Password captured (hidden for security)', 'info');

            await speak('Password received. Say confirm to login, or say retry to start over.');
            state.step = 3;
            if (speechAvailable) {
                startListening();
            } else {
                showTextFallback('Type "confirm" to login or "retry" to start over:');
            }
        }

        /**
         * Handles confirmation input
         * @param {string} input - Confirmation input
         */
        async function handleConfirmation(input) {
            const command = input.toLowerCase().trim();

            if (command.includes('confirm') || command.includes('yes') || command.includes('proceed')) {
                await authenticateUser();
            } else if (command.includes('retry') || command.includes('restart') || command.includes('no')) {
                await restartVoiceLogin();
            } else {
                await speak('Please say confirm to proceed, or say retry to start over.');
                if (speechAvailable) {
                    startListening();
                } else {
                    showTextFallback('Type "confirm" to proceed or "retry" to start over:');
                }
            }
        }

        // ==================== AUTHENTICATION ====================
        /**
         * Authenticates user (DEMO MODE - no backend required)
         */
        async function authenticateUser() {
            showStatus('Authenticating...', 'info');
            await speak('Authenticating. Please wait.');

            try {
                // Simulate authentication delay
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Basic validation
                if (!state.email || !isValidEmail(state.email)) {
                    throw new Error('Invalid email format');
                }

                if (!state.password || state.password.length < 3) {
                    throw new Error('Password too short');
                }

                // Demo mode - accept any valid email/password
                console.log('Demo login successful:', {
                    email: state.email,
                    password: '***hidden***'
                });

                // Login successful
                showStatus(`Login successful! Welcome ${state.email}`, 'success');
                await speak(`Login successful. Welcome ${state.email.split('@')[0]}!`);

                // Store demo credentials in localStorage
                const demoUser = {
                    email: state.email,
                    name: state.email.split('@')[0],
                    loginTime: new Date().toISOString(),
                    loginMethod: 'voice'
                };
                localStorage.setItem('demoUser', JSON.stringify(demoUser));
                localStorage.setItem('isLoggedIn', 'true');

                // Show success for 3 seconds then reset
                setTimeout(() => {
                    showStatus('Demo complete. You can login again or close this page.', 'info');
                    resetVoiceLogin();
                }, 3000);

            } catch (error) {
                console.error('Authentication error:', error);

                let errorMessage = '';
                if (error.message.includes('email')) {
                    errorMessage = 'Invalid email format. Please say a valid email address.';
                } else if (error.message.includes('password')) {
                    errorMessage = 'Password is too short. Please say a longer password.';
                } else {
                    errorMessage = 'Authentication failed. ' + error.message;
                }

                showStatus(errorMessage, 'error');
                await speak(errorMessage);

                // Allow retry
                state.retryCount++;
                if (state.retryCount < CONFIG.MAX_RETRIES) {
                    await speak('Say retry to try again, or say cancel to exit.');
                    state.step = 3;
                    startListening();
                } else {
                    await speak('Maximum retry attempts reached. Please click the voice login button to restart.');
                    resetVoiceLogin();
                }
            } finally {
                // Clear sensitive data from memory
                state.password = '';
            }
        }

        // ==================== TEXT FALLBACK FUNCTIONS ====================
        const textFallbackContainer = document.getElementById('textFallbackContainer');
        const voiceTextInput = document.getElementById('voiceTextInput');
        const submitTextInputBtn = document.getElementById('submitTextInput');
        const voiceInputLabel = document.getElementById('voiceInputLabel');

        /**
         * Shows text input fallback
         */
        function showTextFallback(promptText) {
            textFallbackContainer.style.display = 'block';
            voiceInputLabel.textContent = promptText;
            voiceTextInput.value = '';
            voiceTextInput.focus();
            voiceTextInput.setAttribute('type', state.step === 2 ? 'password' : 'text');
        }

        /**
         * Hides text input fallback
         */
        function hideTextFallback() {
            textFallbackContainer.style.display = 'none';
        }

        /**
         * Handles text input submission
         */
        async function handleTextInput() {
            const input = voiceTextInput.value.trim();
            if (!input) {
                await speak('Please enter a value.');
                return;
            }

            hideTextFallback();
            const sanitizedInput = sanitizeInput(input);
            await processVoiceInput(sanitizedInput);
        }

        // Event listeners for text fallback
        submitTextInputBtn.addEventListener('click', handleTextInput);
        voiceTextInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleTextInput();
            }
        });

        // ==================== VOICE LOGIN FLOW ====================
        /**
         * Starts the voice login process
         */
        async function startVoiceLogin() {
            console.log('=== Voice Login Started ===');

            // Check browser support
            if (!window.speechSynthesis || !(window.SpeechRecognition || window.webkitSpeechRecognition)) {
                showStatus('Voice features are not supported in this browser. Please use Chrome or Edge.', 'error');
                return;
            }

            // Test speech recognition if not already tested
            if (speechAvailable === null) {
                showStatus('Testing speech recognition...', 'info');
                await speak('Testing speech recognition. Please wait.');
                speechAvailable = await testSpeechRecognition();
            }

            // Reset state
            resetVoiceLogin();
            state.step = 1;
            console.log('Step set to 1 (Email input)');

            // Disable manual login during voice login
            disableManualLogin(true);

            if (speechAvailable) {
                // Use voice input
                showStatus('Voice login started. Follow the voice instructions.', 'info');
                await speak('Welcome to voice login. This is a hands-free login system. Please say your email address. For example, john dot doe at example dot com.');
                startListening();
            } else {
                // Fallback to text input
                showStatus('Voice recognition is not available. Using text input instead.', 'warning');
                await speak('Voice recognition is not available on your device. You can type your responses instead.');
                showTextFallback('Please type your email address (e.g., john@example.com)');
            }
        }

        /**
         * Prompts user for current step
         */
        async function promptCurrentStep() {
            switch (state.step) {
                case 1:
                    await speak('Please say your email address.');
                    if (speechAvailable) {
                        startListening();
                    } else {
                        showTextFallback('Please type your email address (e.g., john@example.com):');
                    }
                    break;
                case 2:
                    await speak('Please say your password.');
                    if (speechAvailable) {
                        startListening();
                    } else {
                        showTextFallback('Please type your password:');
                    }
                    break;
                case 3:
                    await speak('Say confirm to proceed, or say retry to start over.');
                    if (speechAvailable) {
                        startListening();
                    } else {
                        showTextFallback('Type "confirm" to proceed or "retry" to start over:');
                    }
                    break;
            }
        }

        /**
         * Restarts voice login from beginning
         */
        async function restartVoiceLogin() {
            showStatus('Restarting voice login...', 'info');
            await speak('Restarting. Please say your email address.');
            state.step = 1;
            state.email = '';
            state.password = '';
            if (speechAvailable) {
                startListening();
            } else {
                showTextFallback('Please type your email address (e.g., john@example.com):');
            }
        }

        /**
         * Resets voice login state
         */
        function resetVoiceLogin() {
            state.step = 0;
            state.email = '';
            state.password = '';
            state.isListening = false;
            state.retryCount = 0;
            state.recognitionActive = false;

            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    // Ignore error if already stopped
                }
            }

            synth.cancel();
            updateVoiceButtonState(false);
            disableManualLogin(false);
            hideTextFallback();
            showStatus('', 'info');
        }

        // ==================== UI UPDATES ====================
        /**
         * Updates voice button visual state
         * @param {boolean} isActive - Is voice recognition active
         */
        function updateVoiceButtonState(isActive) {
            if (isActive) {
                elements.voiceLoginBtn.classList.add('active');
                elements.voiceLoginBtn.innerHTML = 'ðŸŽ¤ Listening... <span class="mic-indicator"></span>';
                elements.voiceLoginBtn.setAttribute('aria-label', 'Voice recognition active. Speaking now.');
            } else {
                elements.voiceLoginBtn.classList.remove('active');
                elements.voiceLoginBtn.innerHTML = 'ðŸŽ¤ Start Voice Login';
                elements.voiceLoginBtn.setAttribute('aria-label', 'Start voice login for blind users. Click and follow spoken instructions.');
            }
        }

        /**
         * Displays status message
         * @param {string} message - Status message
         * @param {string} type - Message type (info, success, error, warning)
         */
        function showStatus(message, type = 'info') {
            if (!message) {
                elements.statusContainer.innerHTML = '';
                return;
            }

            const alertClass = `alert-${type}`;
            elements.statusContainer.innerHTML = `
                <div class="alert ${alertClass}" role="alert">
                    ${message}
                </div>
            `;
        }

        /**
         * Disables/enables manual login form
         * @param {boolean} disabled - Should disable manual login
         */
        function disableManualLogin(disabled) {
            const formElements = elements.manualLoginForm.elements;
            for (let element of formElements) {
                element.disabled = disabled;
            }
            elements.manualLoginBtn.disabled = disabled;
        }

        // ==================== MANUAL LOGIN HANDLER ====================
        /**
         * Handles manual form login (DEMO MODE)
         */
        elements.manualLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            elements.manualLoginBtn.disabled = true;
            elements.manualLoginBtn.textContent = 'Logging in...';

            try {
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Validate inputs
                if (!isValidEmail(email)) {
                    throw new Error('Invalid email format');
                }

                if (password.length < 3) {
                    throw new Error('Password too short');
                }

                // Demo mode - accept any valid credentials
                console.log('Demo manual login successful:', { email, password: '***hidden***' });

                showStatus(`Login successful! Welcome ${email}`, 'success');

                // Store demo credentials
                const demoUser = {
                    email: email,
                    name: email.split('@')[0],
                    loginTime: new Date().toISOString(),
                    loginMethod: 'manual'
                };
                localStorage.setItem('demoUser', JSON.stringify(demoUser));
                localStorage.setItem('isLoggedIn', 'true');

                // Show success message
                setTimeout(() => {
                    showStatus('Demo complete. You can login again or close this page.', 'info');
                    elements.manualLoginForm.reset();
                }, 2000);

            } catch (error) {
                console.error('Login error:', error);
                showStatus(error.message || 'Login failed. Please try again.', 'error');
            } finally {
                elements.manualLoginBtn.disabled = false;
                elements.manualLoginBtn.textContent = 'Login';
            }
        });

        // ==================== EVENT LISTENERS ====================
        elements.voiceLoginBtn.addEventListener('click', startVoiceLogin);

        // Handle keyboard navigation (Enter and Space for voice button)
        elements.voiceLoginBtn.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                startVoiceLogin();
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (recognition) {
                recognition.stop();
            }
            synth.cancel();
        });

        // ==================== INITIALIZATION ====================
        console.log('Voice login system initialized');
        console.log('Browser support:', {
            speechSynthesis: !!window.speechSynthesis,
            speechRecognition: !!(window.SpeechRecognition || window.webkitSpeechRecognition)
        });
    </script>
</body>

</html>